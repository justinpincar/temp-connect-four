<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Connect Four</title>

    <script src="/js/webfont.js"></script>
    <script>
      WebFont.load({
        custom: {
          families: [ 'Source+Sans+Pro:300,400,600:latin' ],
          urls: [ '/css/fonts.css' ]
        }
      });
    </script>

    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/animate.min.css">
    <link rel="stylesheet" href="/css/app.css">

    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type='text/javascript' src='/js/knockout-2.2.1.js'></script>
    <script type="text/javascript" src="/js/jquery.cookie.js"> </script>
    <script type='text/javascript' src='/js/console.js'></script>

    <script>
      App = {};
      App.data = {};

      randomString = function(length) {
        chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var result = '';
        for (var i=length; i>0; --i) {
          result += chars[Math.round(Math.random() * (chars.length - 1))];
        }
        return result;
      }

      App.data.idStr = $.cookie("testIdStr");
      if (!App.data.idStr) {
        App.data.idStr = randomString(16);
        $.cookie("testIdStr", App.data.idStr);
      }
    </script>
  </head>
  <body>
    <!-- Content wrapper -->
    <div class="wrapper">

    <button data-bind="click: refreshRoom">Refresh Room</button><br />
    <br />

    <div class="gameBoard">
      <!-- ko if: game.board() == null -->
      No board.
      <!-- /ko -->
      <!-- ko if: game.board() != null -->
      <div data-bind="template: {foreach: game.board()}" >
        <div class="boardColumn" data-bind="template: {foreach: $data.reverse()}">
          <div data-bind="css: 'boardSpot ' + $root.getPlayerColor($data), click: function() { $root.play($parentContext.$index()) }"></div>
        </div>
      </div>
      <!-- /ko -->
    </div>

    <br />
    <dl data-bind="with: game">
      <dt>State</dt>
      <dd data-bind="text: state"></dd>

      <dt>Action</dt>
      <!-- ko if: action() == null -->
      <dd>null</dd>
      <!-- /ko -->
      <!-- ko if: action() != null -->
      <dl style="margin-left: 40px">
        <dt>Player</dt>
        <dd data-bind="text: action().player"></dd>

        <dt>Timer</dt>
        <dd data-bind="text: action().timer"></dd>
      </dl>
      <!-- /ko -->

      <dt>Winner</dt>
      <dd data-bind="text: winner"></dd>
    </dl>

    <br />
    Visitors
    <ul data-bind="template: {foreach: visitors}">
      <li><span data-bind="text: $data"></span></li>
    </ul>
    <br />

    <!-- Used for debugging, do not put restrictions on these actions -->
    <div class="debugPanel" data-bind="visible: debugVisible">
      <dl>
        <dt>Id Str</dt>
        <dd data-bind="text: idStr"></dd>
      </dl>
      <hr />
      <button data-bind="click: sit">Sit</button><br /><br />
      <button data-bind="click: nextGame">Next Game</button><br />
    </div>
  </div>

    <script>
      function GameModel(data) {
        var self = this;
        data = data || {};

        self.players = ko.observableArray();
        self.board = ko.observable();
        self.state = ko.observable();
        self.action = ko.observable();
        self.winner = ko.observable();

        self.load = function(data) {
          self.players(data.players);
          self.board(data.board);
          self.state(data.state);
          self.action(data.action);
          self.winner(data.winner);
        };
        self.load(data);
      }

      function PokerViewModel() {
        var self = this;
        window.A = self;

        self.idStr = ko.observable(App.data.idStr);
        self.isSitting = ko.observable(false);

        self.board = ko.observableArray();

        self.visitors = ko.observableArray([]);
        self.game = new GameModel();

        self.debugVisible = ko.observable(true);

        self.colors = ['red', 'black'];
        self.getPlayerColor = function(player) {
          if (player == null) {
            return '';
          }

          var players = self.game.players();
          var playerIndex = players.indexOf(player);
          if (playerIndex == -1) {
            return '';
          }

          return self.colors[playerIndex];
        };

        App.socket.on('setRoom', function(data) {
          console.debug('setRoom', data);
          self.visitors(data.visitors);
          self.game.load(data.game);

          if (data.game && data.game.players && (data.game.players.indexOf(self.idStr()) != -1)) {
            self.isSitting(true);
          }
        });

        self.sit = function() {
          App.socket.emit('action', {
            action: 'sit'
          });
        }

        self.stand = function() {
          // TODO
        }

        self.play = function(column) {
          console.log("column is: " + column);
          App.socket.emit('action', {
            action: 'play',
            column: column
          });
        };

        self.nextGame = function() {
          App.socket.emit('nextGame');
        }
        self.refreshRoom = function() {
          App.socket.emit('refreshRoom');
        }
      }

      var initSocket = function() {
        var socket_ok = function() {
          console.info("Socket ok");
          App.socket.emit('joinRoom', {
            idStr: App.data.idStr
          });
        };

        var socket_error = function() {
          console.error("Socket error");
        };


        if (document.location.host == "www.bitsaloon.com") {
          App.socket = io.connect('', {secure: true, resource: "3001/socket.io"});
        } else {
          App.socket = io.connect('//localhost:3001');
        }

        App.socket.on('connect', socket_ok);
        App.socket.on('reconnect', socket_ok);
        App.socket.on('disconnect', socket_error);
        App.socket.on('connect_failed', socket_error);
        App.socket.on('reconnect_failed', socket_error);
        App.socket.on('serverError', function(data) {
          console.error("serverError", data);
        });

        ko.applyBindings(new PokerViewModel());
      };

      var scriptSrc = null;
      if (document.location.host == "www.bitsaloon.com") {
        scriptSrc = "/3001/socket.io/socket.io.js";
      } else {
        scriptSrc = "//localhost:3001/socket.io/socket.io.js";
      }

      $.getScript(scriptSrc, initSocket);
    </script>
  </body>
</html>

